# 검색 키워드를 일부 입력했을 때 검색어를 추천해주는 기능(자동 완성 기능)
## ✅ 검색 키워드를 일부 입력했을 때 검색어를 추천해주는 기능(자동 완성 기능)
자동 완성 기능을 구현하는 방법에는 정말 다양한 방법이 존재한다.
그 중에서 가성비 좋은 방법인 `search_as_you_type`이라는 걸 활용해서 구현하는 방법을 배워보자.

## ✅ `search_as_you_type`이란?
* Elasticsearch에서 자동완성 기능을 쉽게 구현할 수 있게 설계된 데이터 타입
* `text` 타입처럼 애널라이저(Analyzer)를 거쳐 토큰으로 분리된다.
* 이 타입을 활용해 필드를 만들면 내부적으로 `_2gram`, `_3gram`이라는 멀티 필드도 같이 만든다.

## ✅ `_2gram`, `_3gram`은 어떻게 구성되어 있을까?
* `_2gram`: 두 단어씩 묶어서 토큰을 생성
* `_3gram`: 세 단어씩 묶어서 토큰을 생성
```
DELETE /products

PUT /products
{
    "mappings": {
        "properties": {
            "name": {
                "type": "search_as_you_type",
                "analyzer": "nori"
            }
        }
    }
}

GET /products/_analyze
{
    "field": "name",
    "text": "You have the big banana"
}

GET /products/_analyze
{
    "field": "name._2gram",
    "text": "You have the big banana"
}

GET /products/_analyze
{
    "field": "name._3gram",
    "text": "You have the big banana"
}

GET /products/_analyze
{
    "field": "name",
    "text": "프리미엄 감귤 선물세트"
}

GET /products/_analyze
{
    "field": "name._2gram",
    "text": "프리미엄 감귤 선물세트"
}

GET /products/_analyze
{
    "field": "name._3gram",
    "text": "프리미엄 감귤 선물세트"
}
```

## ✅ 검색해보기
```
DELETE /products

PUT /products
{
    "mappings": {
        "properties": {
            "name": {
                "type": "search_as_you_type",
                "analyzer": "nori"
            }
        }
    }
}

// 데이터 삽입
POST /products/_doc
{
    "name": "곱창 돌김생김"
}
POST /products/_doc
{
    "name": "구운 돌김"
}
POST /products/_doc
{
    "name": "완도 곱창 돌김 100매"
}
POST /products/_doc
{
    "name": "삼성 노트북"
}
POST /products/_doc
{
    "name": "Nike 신발"
}


// 데이터 검색
GET /products/_search
{
    "query": {
        "multi_match": {
            "query": "돌김",
            "type": "bool_prefix",
            "fields": [
                "name",
                "name._2gram",
                "name._3gram"
            ]
        }
    }
}

// 순서 바뀌어도 검색 잘됨
GET /products/_search
{
    "query": {
        "multi_match": {
            "query": "돌김 구운",
            "type": "bool_prefix",
            "fields": [
                "name",
                "name._2gram",
                "name._3gram"
            ]
        }
    }
}

// 순서까지 일치하면 score가 더 높게 측정
GET /products/_search
{
    "query": {
        "multi_match": {
            "query": "구운 돌김",
            "type": "bool_prefix",
            "fields": [
                "name",
                "name._2gram",
                "name._3gram"
            ]
        }
    }
}
```
* `multi_match`: 여러 필드에 걸쳐서 데이터 검색
* `bool_prefix`: 앞쪽 단어는 match, 마지막 단어는 prefix match
  * `you have th`라고 검색하면 앞쪽 단어인 `you`와 `have`는 역인덱스에 저장되는 토큰과 일치하는 데이터를 찾고, 마지막 단어인 `th`는 역인덱스에 저장된 토큰 중에 `th`로 시작하는 데이터를 찾는다.
* `name._2gram`, `name_.3gram` 필드에서도 검색을 하는 이유는 연속적으로 단어가 일치할수록 score를 더 높게 측정해 상위 노출되도록 만글기 위함이다.
